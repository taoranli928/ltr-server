<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- Safari æ ¸å¿ƒé€‚é…ï¼šç¦æ­¢ç¼©æ”¾+å®‰å…¨åŒº+ç¦ç”¨è‡ªåŠ¨è°ƒæ•´ -->
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="color-scheme" content="light only">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="white">
    <meta name="format-detection" content="telephone=no"> <!-- ç¦æ­¢Safariè¯†åˆ«æ‰‹æœºå· -->
    <title>æˆ¿é—´</title>
    <style>
        /* === å…¨å±€é‡ç½® & Safari å…¼å®¹ === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "PingFang SC", sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* ç¦ç”¨Safariç‚¹å‡»é«˜äº® */
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
            tap-highlight-color: rgba(0, 0, 0, 0);
        }

        html, body {
            height: 100%;
            width: 100%;
            background-color: #fafafa;
            /* Safari æ»šåŠ¨ä¼˜åŒ–ï¼šç¦ç”¨å¼¹æ€§æ»šåŠ¨ */
            overflow: hidden;
            touch-action: manipulation; /* ç¦ç”¨åŒå‡»ç¼©æ”¾ */
        }

        /* === é¡µé¢å®¹å™¨ === */
        .page-container {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        /* === é¡¶éƒ¨å¯¼èˆªæ  (Safari å›ºå®š+æ¯›ç»ç’ƒ) === */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px); /* Safari æ¯›ç»ç’ƒ */
            -webkit-backdrop-filter: blur(10px);
            border-radius: 0 0 20px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            margin-bottom: 12px;
        }

        .navbar-title {
            font-size: 18px;
            font-weight: 600;
            color: #111;
        }

        .leave-btn {
            font-size: 15px;
            color: #ff3b30;
            background: none;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .leave-btn:active {
            background-color: rgba(255, 59, 48, 0.1);
        }

        /* === æˆå‘˜åˆ—è¡¨åŒºåŸŸ (Safari æ»šåŠ¨ä¼˜åŒ–) === */
        .content-wrap {
            flex: 1;
            overflow-y: auto;
            /* Safari å¼¹æ€§æ»šåŠ¨ + æ»šåŠ¨æ¡éšè— */
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* éšè—Firefoxæ»šåŠ¨æ¡ */
        }

        .content-wrap::-webkit-scrollbar {
            display: none; /* éšè—Safariæ»šåŠ¨æ¡ */
        }

        .member-card {
            background: #fff;
            border-radius: 20px;
            padding: 20px;
            margin: 0 12px 12px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
        }

        /* æ–°å¢ï¼šå¡ç‰‡å¤´éƒ¨å¸ƒå±€ï¼ˆæ ‡é¢˜+ç»“ç®—æŒ‰é’®ï¼‰ */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 15px;
            color: #8e8e93;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f5f5f5;
        }

        .card-header-title {
            color: #8e8e93;
            font-size: 15px;
        }

        /* æ–°å¢ï¼šæŸ¥çœ‹ç»“ç®—æŒ‰é’®æ ·å¼ */
        .check-settlement-btn {
            font-size: 14px;
            color: #6c63ff;
            background: none;
            border: none;
            padding: 6px 10px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .check-settlement-btn:active {
            background-color: rgba(108, 99, 255, 0.1);
        }

        /* å…³é”®ä¿®å¤1ï¼šç»™æˆå‘˜åˆ—è¡¨çˆ¶å®¹å™¨æ·»åŠ é—´è·æ§åˆ¶ï¼ˆä¼˜å…ˆçº§æ›´é«˜ï¼‰ */
        #memberList {
            display: flex;
            flex-direction: column;
            gap: 16px; /* æˆå‘˜é¡¹ä¹‹é—´çš„é—´è·ï¼ˆæ ¸å¿ƒï¼ï¼‰ */
        }

        /* === æˆå‘˜é¡¹ (å¡ç‰‡å¼è®¾è®¡) === */
        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 12px;
            border-radius: 16px;
            /* å…³é”®ä¿®å¤2ï¼šç§»é™¤è¿‡å¤§çš„margin-bottomï¼Œæ”¹ç”¨çˆ¶å®¹å™¨gapæ§åˆ¶ */
            margin-bottom: 0 !important; /* !important ç¡®ä¿è¦†ç›–å…¶ä»–æ ·å¼ */
        }

        .member-item.self {
            background: linear-gradient(135deg, #f0f8ff 0%, #e8f4f8 100%);
            border: 1px solid #e3f2fd;
        }

        .member-item.other {
            background: #fafafa;
            transition: all 0.2s;
        }

        .member-item.other:active {
            background: #f5f5f5;
            transform: scale(0.98); /* Safari è§¦æ§åé¦ˆ */
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #6c63ff;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
            margin-right: 12px;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-size: 16px;
            color: #111;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .member-tag {
            font-size: 11px;
            color: #8e8e93;
        }

        .score-wrap {
            text-align: right;
        }

        .score-label {
            font-size: 11px;
            color: #8e8e93;
            margin-bottom: 2px;
        }

        .score-value {
            font-size: 18px;
            font-weight: 600;
        }

        .score-positive {
            color: #ff3b30;
        }

        .score-negative {
            color: #34c759;
        }

        /* === å¼¹çª—é€šç”¨æ ·å¼ (Safari é”®ç›˜é€‚é…) === */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: flex-end; /* ä»åº•éƒ¨å¼¹å‡ºï¼Œé€‚é…Safarié”®ç›˜ */
            justify-content: center;
            z-index: 999;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            width: 100%;
            background: #fff;
            border-radius: 24px 24px 0 0;
            padding: 24px 20px env(safe-area-inset-bottom) 20px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #111;
            margin-bottom: 4px;
        }

        .modal-subtitle {
            font-size: 14px;
            color: #8e8e93;
        }

        /* === åˆ†æ•°è¾“å…¥æ¡† (ç¦ç”¨ä¸Šä¸‹æŒ‰é”®) === */
        .input-group {
            margin-bottom: 24px;
        }

        .input-label {
            font-size: 15px;
            color: #111;
            margin-bottom: 8px;
            display: block;
        }

        .score-input {
            width: 100%;
            padding: 20px 16px;
            font-size: 24px;
            font-weight: 600;
            border: 1px solid #e5e5e5;
            border-radius: 16px;
            background: #fafafa;
            text-align: center;
            /* ç¦ç”¨Safarié»˜è®¤æ ·å¼ */
            -webkit-appearance: none;
            appearance: none;
            /* éšè—ä¸Šä¸‹ç®­å¤´ */
        }

        /* æ ¸å¿ƒï¼šç¦ç”¨è¾“å…¥æ¡†ä¸Šä¸‹ç®­å¤´ & æŒ‰é”® */
        .score-input::-webkit-outer-spin-button,
        .score-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .score-input[type=number] {
            -moz-appearance: textfield; /* Firefox */
        }

        .error-tip {
            font-size: 13px;
            color: #ff3b30;
            text-align: center;
            margin-top: 8px;
            display: none;
        }

        /* === æŒ‰é’®ç»„ === */
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 16px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            transition: all 0.2s;
            -webkit-appearance: none;
            appearance: none;
        }

        .btn-cancel {
            background: #f5f5f5;
            color: #8e8e93;
        }

        .btn-cancel:active {
            background: #e5e5e5;
        }

        .btn-confirm {
            background: #6c63ff;
            color: #fff;
        }

        .btn-confirm:active {
            background: #5a54e0;
        }

        /* === åŠ è½½æç¤º === */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 14px;
            z-index: 1000;
            display: none;
        }

        /* === æ–°å¢ï¼šç»“ç®—åˆ—è¡¨æ ·å¼ === */
        .settlement-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        .settlement-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: #fafafa;
            border-radius: 16px;
        }

        .settlement-user-group {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .settlement-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #6c63ff;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            margin-right: 10px;
        }

        .settlement-arrow {
            font-size: 16px;
            color: #8e8e93;
            margin: 0 12px;
        }

        .settlement-score {
            font-size: 18px;
            font-weight: 600;
            color: #6c63ff;
            min-width: 60px;
            text-align: right;
        }

        .empty-settlement {
            text-align: center;
            padding: 40px 0;
            color: #8e8e93;
            font-size: 14px;
        }
    </style>
</head>
<body>
<div class="page-container">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="navbar">
        <div class="navbar-title" id="roomTitle">æˆ¿é—´ #100001</div>
        <button class="leave-btn" id="leaveBtn">è¿”å›å¤§å…</button>
    </div>

    <!-- å†…å®¹åŒºåŸŸ -->
    <div class="content-wrap">
        <div class="member-card">
            <!-- ä¿®æ”¹ï¼šå¡ç‰‡å¤´éƒ¨å¢åŠ ç»“ç®—æŒ‰é’® -->
            <div class="card-header">
                <div class="card-header-title">æˆ¿é—´æˆå‘˜</div>
                <button class="check-settlement-btn" id="checkSettlementBtn">æŸ¥çœ‹æˆ¿é—´ç»“ç®—</button>
            </div>
            <div id="memberList"></div>
        </div>
    </div>
</div>

<!-- åˆ†æ•°è¾“å…¥å¼¹çª— -->
<div class="modal-overlay" id="scoreModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="modalTargetName">ä» æµ‹è¯•ç”¨æˆ· å¤„è·å–</div>
        </div>
        <div class="input-group">
            <label class="input-label" for="scoreInput">è¾“å…¥é‡‘é¢</label>
            <input type="number" class="score-input" id="scoreInput" inputmode="numeric" pattern="[0-9]*">
            <div class="error-tip" id="errorTip">è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢</div>
        </div>
        <div class="btn-group">
            <button class="btn btn-cancel" id="cancelBtn">å–æ¶ˆ</button>
            <button class="btn btn-confirm" id="confirmBtn">ç¡®è®¤</button>
        </div>
    </div>
</div>

<!-- æ–°å¢ï¼šæˆ¿é—´ç»“ç®—å¼¹çª— -->
<div class="modal-overlay" id="settlementModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">æˆ¿é—´ç»“ç®—</div>
            <div class="modal-subtitle" id="settlementRoomId">æˆ¿é—´ #100001</div>
        </div>
        <!-- ç»“ç®—åˆ—è¡¨å®¹å™¨ -->
        <div id="settlementList" class="settlement-list"></div>
        <!-- å…³é—­æŒ‰é’® -->
        <div class="btn-group">
            <button class="btn btn-cancel" id="settlementCancelBtn">å…³é—­</button>
        </div>
    </div>
</div>

<!-- åŠ è½½æç¤º -->
<div class="loading" id="loadingToast">åŠ è½½ä¸­...</div>

<script src="{{ url_for('static', filename='js/common.js') }}"></script>

<script>
    // === æ ¸å¿ƒå˜é‡ ===
    const roomTitleEl = document.getElementById('roomTitle');
    const memberListEl = document.getElementById('memberList');
    const scoreModal = document.getElementById('scoreModal');
    const modalTargetName = document.getElementById('modalTargetName');
    const scoreInput = document.getElementById('scoreInput');
    const errorTip = document.getElementById('errorTip');
    const cancelBtn = document.getElementById('cancelBtn');
    const confirmBtn = document.getElementById('confirmBtn');
    const leaveBtn = document.getElementById('leaveBtn');

    // æ–°å¢ï¼šç»“ç®—ç›¸å…³å˜é‡
    const checkSettlementBtn = document.getElementById('checkSettlementBtn');
    const settlementModal = document.getElementById('settlementModal');
    const settlementRoomId = document.getElementById('settlementRoomId');
    const settlementList = document.getElementById('settlementList');
    const settlementCancelBtn = document.getElementById('settlementCancelBtn');

    let roomId;
    let currentUsername;
    let targetUserName = '';
    let roomDetail = [];
    let roomSummary = [];

    // æ‰“å¼€åˆ†æ•°å¼¹çª—
    function openModal(targetName) {
        targetUserName = targetName;
        modalTargetName.textContent = `ç»™ ã€${targetName}ã€‘ä»˜é’± ğŸ¤¡ğŸ˜­`;
        scoreInput.value = '';
        errorTip.style.display = 'none';
        scoreModal.classList.add('show');

        // Safari èšç„¦ä¿®å¤ï¼šå»¶è¿Ÿèšç„¦é¿å…é”®ç›˜å¼‚å¸¸
        setTimeout(() => {
            scoreInput.focus();
            // å¼ºåˆ¶å¼¹å‡ºæ•°å­—é”®ç›˜
            scoreInput.setAttribute('type', 'tel');
            setTimeout(() => {
                scoreInput.setAttribute('type', 'number');
            }, 100);
        }, 300);
    }

    // å…³é—­åˆ†æ•°å¼¹çª—
    function closeModal() {
        scoreModal.classList.remove('show');
        scoreInput.blur();
        // Safari é”®ç›˜æ”¶èµ·åé‡ç½®æ»šåŠ¨
        setTimeout(() => {
            window.scrollTo(0, 0);
        }, 100);
    }

    // æ–°å¢ï¼šæ‰“å¼€ç»“ç®—å¼¹çª—
    function openSettlementModal() {
        settlementRoomId.textContent = `${roomId}`;
        renderSettlementList(); // æ¸²æŸ“ç»“ç®—åˆ—è¡¨
        settlementModal.classList.add('show');
    }

    // æ–°å¢ï¼šå…³é—­ç»“ç®—å¼¹çª—
    function closeSettlementModal() {
        settlementModal.classList.remove('show');
        // Safari æ»šåŠ¨é‡ç½®
        setTimeout(() => {
            window.scrollTo(0, 0);
        }, 100);
    }

    // === æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ ===
    async function initPage() {
        currentUsername = getUserFromCookie()
        if (!currentUsername) {
            gotoLogin();
        }

        // è·å–æˆ¿é—´ID
        const urlParams = new URLSearchParams(window.location.search);
        roomId = urlParams.get('roomId');
        if (!roomId) {
            gotoLobby();
        }
        roomTitleEl.textContent = `æˆ¿é—´ ${roomId}`;

        // åŠ è½½æˆå‘˜åˆ—è¡¨ï¼ˆåŒ…å«ç»“ç®—æ•°æ®ï¼‰
        await loadRoomMembers();
        setInterval(loadRoomMembers, 10000);

        // åˆ†æ•°å¼¹çª—äº‹ä»¶
        cancelBtn.addEventListener('click', closeModal);
        confirmBtn.addEventListener('click', confirmScore);
        scoreModal.addEventListener('click', (e) => {
            if (e.target === scoreModal) closeModal();
        });

        // æ–°å¢ï¼šç»“ç®—å¼¹çª—äº‹ä»¶
        checkSettlementBtn.addEventListener('click', openSettlementModal);
        settlementCancelBtn.addEventListener('click', closeSettlementModal);
        settlementModal.addEventListener('click', (e) => {
            if (e.target === settlementModal) closeSettlementModal();
        });

        // === Safari å…³é”®ä¼˜åŒ–ï¼šç¦ç”¨è¾“å…¥æ¡†ä¸Šä¸‹æŒ‰é”® ===
        scoreInput.addEventListener('keydown', (e) => {
            // ç¦ç”¨ä¸Šä¸‹ç®­å¤´é”®
            if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                e.preventDefault();
            }
            // ç¦ç”¨åŠ å‡å·
            if (e.key === '+' || e.key === '-') {
                e.preventDefault();
            }
        });

        // Safari è¾“å…¥æ¡†å†…å®¹è¿‡æ»¤ï¼ˆåªä¿ç•™æ•°å­—ï¼‰
        scoreInput.addEventListener('input', () => {
            scoreInput.value = scoreInput.value.replace(/[^0-9]/g, '');
            errorTip.style.display = 'none';
        });

        leaveBtn.addEventListener('click', () => {
            gotoLobby();
        });

        // Safari é”®ç›˜æ”¶èµ·ç›‘å¬
        window.addEventListener('resize', () => {
            if (!scoreModal.classList.contains('show') && !settlementModal.classList.contains('show')) {
                document.body.scrollTop = 0;
            }
        });
    }

    async function loadRoomMembers() {
        try {
            const res = await fetch('/api/room/detail', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({roomId})
            });
            const data = await res.json();
            roomDetail = data.detail || [];
            roomSummary = data.roomSummary || [];

            renderMemberList();
        } catch (err) {
            console.error('åŠ è½½æˆå‘˜å¤±è´¥:', err);
        }
    }

    function renderMemberList() {
        memberListEl.innerHTML = '';

        const selfMember = roomDetail.find(m => m.username === currentUsername);
        const otherMembers = roomDetail.filter(m => m.username !== currentUsername);

        if (selfMember) {
            const selfItem = document.createElement('div');
            selfItem.innerHTML = renderMemberItem(selfMember, true);
            memberListEl.appendChild(selfItem);
        }

        otherMembers.forEach(member => {
            const memberItemHtml = renderMemberItem(member, false);
            // åˆ›å»ºDOMå…ƒç´ å¹¶ç›´æ¥æ·»åŠ åˆ°åˆ—è¡¨
            const memberItem = document.createElement('div');
            memberItem.innerHTML = memberItemHtml;
            // æ‰¾åˆ°.otherç±»çš„å…ƒç´ å¹¶ç»‘å®šç‚¹å‡»äº‹ä»¶
            const otherItem = memberItem.querySelector('.member-item.other');
            if (otherItem) {
                otherItem.addEventListener('click', () => {
                    console.log('ç‚¹å‡»ç”¨æˆ·ï¼š', member.username); // è°ƒè¯•ç”¨ï¼Œå¯åˆ é™¤
                    openModal(member.username);
                });
            }
            memberListEl.appendChild(memberItem);
        });
    }

    // æ¸²æŸ“å•ä¸ªæˆå‘˜é¡¹
    function renderMemberItem(member, isSelf) {
        const avatarText = member.username.substring(0, 1);
        const scoreClass = member.score >= 0 ? 'score-positive' : 'score-negative';
        const scoreText = member.score >= 0 ? `${member.score}` : member.score;

        return `
                <div class="member-item ${isSelf ? 'self' : 'other'}">
                    <div class="member-avatar">${avatarText}</div>
                    <div class="member-info">
                        <div class="member-name">${member.username}</div>
                    </div>
                    <div class="score-wrap">
                        <div class="score-value ${scoreClass}">${scoreText}</div>
                    </div>
                </div>
            `;
    }

    // æ–°å¢ï¼šæ¸²æŸ“ç»“ç®—åˆ—è¡¨
    function renderSettlementList() {
        settlementList.innerHTML = '';

        // æ— ç»“ç®—æ•°æ®æ—¶æ˜¾ç¤ºç©ºæç¤º
        if (!roomSummary || roomSummary.length === 0) {
            settlementList.innerHTML = `
                    <div class="empty-settlement">
                        æš‚æ— ç»“ç®—ä¿¡æ¯
                    </div>
                `;
            return;
        }

        // æ¸²æŸ“ç»“ç®—é¡¹
        roomSummary.forEach(item => {
            const fromAvatar = item.from_user.substring(0, 1);
            const toAvatar = item.to_user.substring(0, 1);

            const settlementItem = document.createElement('div');
            settlementItem.className = 'settlement-item';
            settlementItem.innerHTML = `
                    <div class="settlement-user-group">
                        <div class="settlement-avatar">${fromAvatar}</div>
                        <div class="member-info">
                            <div class="member-name">${item.from_user}</div>
                        </div>
                    </div>
                    <div class="settlement-arrow">â†’</div>
                    <div class="settlement-user-group">
                        <div class="settlement-avatar">${toAvatar}</div>
                        <div class="member-info">
                            <div class="member-name">${item.to_user}</div>
                        </div>
                    </div>
                    <div class="settlement-score">${item.score}</div>
                `;
            settlementList.appendChild(settlementItem);
        });
    }

    // ç¡®è®¤åˆ†æ•°
    async function confirmScore() {
        const score = parseInt(scoreInput.value.trim());

        // æ ¡éªŒ
        if (isNaN(score) || score <= 0) {
            errorTip.style.display = 'block';
            return;
        }

        try {
            const res = await fetch('/api/room/transfer', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    roomId,
                    targetUserName,
                    score,
                })
            });
            const data = await res.json();
            checkLoginOrGotoLoginPage(data)
            closeModal();
            await loadRoomMembers(); // é‡æ–°åŠ è½½æ•°æ®ï¼ˆåŒ…å«ç»“ç®—ï¼‰
        } catch (err) {
            errorTip.textContent = 'æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•';
            errorTip.style.display = 'block';
            console.error('æäº¤åˆ†æ•°å¤±è´¥:', err);
        }
    }

    // åˆå§‹åŒ–
    initPage();
</script>
</body>
</html>